(section 'filter'
  (version)
  (define 'code' (param)
    (loop (varuint32) (eval 'code.function'))
  )
  (define 'code.address' (param)
    (varuint32)
    (varuint32)
  )
  (define 'code.br_table' (param)
    (uint8)
    (loop (varuint32) (uint32))
    (uint32)
  )
  (define 'code.br_target' (param)
    (uint8)
    (varuint32)
  )
  (define 'code.call_args' (param)
    (varuint32)
    (varuint32)
  )
  (define 'code.function' (param)
    (block
      (loop (varuint32) (eval 'code.local'))
      (loop.unbounded
        (eval 'code.opcode')
        (eval 'code.inst')
      )
    )
  )
  (define 'code.local' (param)
    (varuint32)
    (uint8)
  )
  (define 'code.inst' (param)
    (switch (read)
      (void)
      (case (u8.const 6) (eval 'code.br_target'))
      (case (u8.const 7) (eval 'code.br_target'))
      (case (u8.const 8) (eval 'code.br_table'))
      (case (u8.const 9) (uint8))
      (case (u8.const 16) (varint32))
      (case (u8.const 17) (varint64))
      (case (u8.const 18) (uint64))
      (case (u8.const 19) (uint32))
      (case (u8.const 20) (varuint32))
      (case (u8.const 21) (varuint32))
      (case (u8.const 22) (eval 'code.call_args'))
      (case (u8.const 23) (eval 'code.call_args'))
      (case (u8.const 24) (eval 'code.call_args'))
      (case (u8.const 32) (eval 'code.address'))
      (case (u8.const 33) (eval 'code.address'))
      (case (u8.const 34) (eval 'code.address'))
      (case (u8.const 35) (eval 'code.address'))
      (case (u8.const 36) (eval 'code.address'))
      (case (u8.const 37) (eval 'code.address'))
      (case (u8.const 38) (eval 'code.address'))
      (case (u8.const 39) (eval 'code.address'))
      (case (u8.const 40) (eval 'code.address'))
      (case (u8.const 41) (eval 'code.address'))
      (case (u8.const 42) (eval 'code.address'))
      (case (u8.const 43) (eval 'code.address'))
      (case (u8.const 44) (eval 'code.address'))
      (case (u8.const 45) (eval 'code.address'))
      (case (u8.const 46) (eval 'code.address'))
      (case (u8.const 47) (eval 'code.address'))
      (case (u8.const 48) (eval 'code.address'))
      (case (u8.const 49) (eval 'code.address'))
      (case (u8.const 50) (eval 'code.address'))
      (case (u8.const 51) (eval 'code.address'))
      (case (u8.const 52) (eval 'code.address'))
      (case (u8.const 53) (eval 'code.address'))
      (case (u8.const 54) (eval 'code.address'))
    )
  )
  (define 'code.opcode' (param) (uint8))
  (define 'data' (param)
    (loop (varuint32) (eval 'data.segment'))
  )
  (define 'data.segment' (param)
    (varuint32)
    (loop (varuint32) (uint8))
  )
  (define 'export' (param)
    (loop (varuint32) (eval 'export.entry'))
  )
  (define 'export.entry' (param)
    (varuint32)
    (eval 'export.symbol')
  )
  (define 'export.symbol' (param)
    (loop (varuint32) (uint8))
  )
  (define 'function' (param)
    (loop (varuint32) (varuint32))
  )
  (define 'import' (param)
    (loop (varuint32) (eval 'import.entry'))
  )
  (define 'import.entry' (param)
    (varuint32)
    (eval 'import.symbol')
    (eval 'import.symbol')
  )
  (define 'import.symbol' (param)
    (loop (varuint32) (uint8))
  )
  (define 'memory' (param)
    (varuint32)
    (varuint32)
    (uint8)
  )
  (define 'name' (param)
    (loop (varuint32) (eval 'name.function'))
  )
  (define 'name.function' (param)
    (eval 'name.symbol')
    (loop (varuint32) (eval 'name.symbol'))
  )
  (define 'name.symbol' (param)
    (loop (varuint32) (uint8))
  )
  (define 'start' (param) (varuint32))
  (define 'table' (param)
    (loop (varuint32) (varuint32))
  )
  (define 'type' (param)
    (loop (varuint32)
      (uint8)
      (loop (varuint32) (uint8))
      (loop (varuint32) (uint8))
    )
  )
)
