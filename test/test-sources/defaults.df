(section 'filter'
  (version)
  (define 'code' (params)
    (loop (varuint32) (eval 'code.function'))
  )
  (define 'code.address' (params)
    (varuint32)
    (varuint32)
  )
  (define 'code.br_table' (params)
    (uint8)
    (loop (varuint32) (uint32))
    (uint32)
  )
  (define 'code.br_target' (params)
    (uint8)
    (varuint32)
  )
  (define 'code.call_args' (params)
    (varuint32)
    (varuint32)
  )
  (define 'code.function' (params)
    (block
      (loop (varuint32) (eval 'code.local'))
      (loop.unbounded
        (eval 'code.opcode')
        (eval 'code.inst')
      )
    )
  )
  (define 'code.local' (params)
    (varuint32)
    (uint8)
  )
  (define 'code.inst' (params)
    (switch (read)
      (void)
      (case (u8.const 0x6) (eval 'code.br_target'))
      (case (u8.const 0x7) (eval 'code.br_target'))
      (case (u8.const 0x8) (eval 'code.br_table'))
      (case (u8.const 0x9) (uint8))
      (case (u8.const 0x10) (varint32))
      (case (u8.const 0x11) (varint64))
      (case (u8.const 0x12) (uint64))
      (case (u8.const 0x13) (uint32))
      (case (u8.const 0x14) (varuint32))
      (case (u8.const 0x15) (varuint32))
      (case (u8.const 0x16) (eval 'code.call_args'))
      (case (u8.const 0x17) (eval 'code.call_args'))
      (case (u8.const 0x18) (eval 'code.call_args'))
      (case (u8.const 0x20) (eval 'code.address'))
      (case (u8.const 0x21) (eval 'code.address'))
      (case (u8.const 0x22) (eval 'code.address'))
      (case (u8.const 0x23) (eval 'code.address'))
      (case (u8.const 0x24) (eval 'code.address'))
      (case (u8.const 0x25) (eval 'code.address'))
      (case (u8.const 0x26) (eval 'code.address'))
      (case (u8.const 0x27) (eval 'code.address'))
      (case (u8.const 0x28) (eval 'code.address'))
      (case (u8.const 0x29) (eval 'code.address'))
      (case (u8.const 0x2a) (eval 'code.address'))
      (case (u8.const 0x2b) (eval 'code.address'))
      (case (u8.const 0x2c) (eval 'code.address'))
      (case (u8.const 0x2d) (eval 'code.address'))
      (case (u8.const 0x2e) (eval 'code.address'))
      (case (u8.const 0x2f) (eval 'code.address'))
      (case (u8.const 0x30) (eval 'code.address'))
      (case (u8.const 0x31) (eval 'code.address'))
      (case (u8.const 0x32) (eval 'code.address'))
      (case (u8.const 0x33) (eval 'code.address'))
      (case (u8.const 0x34) (eval 'code.address'))
      (case (u8.const 0x35) (eval 'code.address'))
      (case (u8.const 0x36) (eval 'code.address'))
    )
  )
  (define 'code.opcode' (params) (uint8))
  (define 'data' (params)
    (loop (varuint32) (eval 'data.segment'))
  )
  (define 'data.segment' (params)
    (varuint32)
    (loop (varuint32) (uint8))
  )
  (define 'export' (params)
    (loop (varuint32) (eval 'export.entry'))
  )
  (define 'export.entry' (params)
    (varuint32)
    (eval 'export.symbol')
  )
  (define 'export.symbol' (params)
    (loop (varuint32) (uint8))
  )
  (define 'function' (params)
    (loop (varuint32) (varuint32))
  )
  (define 'import' (params)
    (loop (varuint32) (eval 'import.entry'))
  )
  (define 'import.entry' (params)
    (varuint32)
    (eval 'import.symbol')
    (eval 'import.symbol')
  )
  (define 'import.symbol' (params)
    (loop (varuint32) (uint8))
  )
  (define 'memory' (params)
    (varuint32)
    (varuint32)
    (uint8)
  )
  (define 'name' (params)
    (loop (varuint32) (eval 'name.function'))
  )
  (define 'name.function' (params)
    (eval 'name.symbol')
    (loop (varuint32) (eval 'name.symbol'))
  )
  (define 'name.symbol' (params)
    (loop (varuint32) (uint8))
  )
  (define 'start' (params) (varuint32))
  (define 'table' (params)
    (loop (varuint32) (varuint32))
  )
  (define 'type' (params)
    (loop (varuint32)
      (uint8)
      (loop (varuint32) (uint8))
      (loop (varuint32) (uint8))
    )
  )
)
